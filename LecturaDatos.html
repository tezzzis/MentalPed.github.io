<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Info del Usuario</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <header class="header">
        <div class="logo">
            <img src="LOGO_BLANCO.png" alt="Logo Mental ped">
        </div>
        <nav>
            <ul class="nav-links">
                <li><a href="index.html">Inicio</a></li>
                <li><a href="#">Informacion</a></li>
            </ul>
        </nav>
        <a class="btn" href="mailto:email@email.de"><button>Contact</button></a>
    </header>

    <div class="tabs">
        <button class="tab-btn active" data-section="diario">Anotaciones del diario</button>
        <button class="tab-btn" data-section="game">Respuestas del Test</button>
        <button class="tab-btn" data-section="pe">Respuestas pregunta diaria</button>
    </div>

    <div id="diarioSection" class="two-column-container">
        <div class="dates-column">
            <h2>Anotaciones del diario</h2>
            <div id="diarioDates"></div>
        </div>
        <div class="content-column">
            <div id="diarioContent"></div>
        </div>
    </div>

    <div id="gameSection" class="two-column-container">
        <div class="dates-column">
            <h2>Respuestas del test</h2>
            <div id="gameDates"></div>
        </div>
        <div class="content-column">
            <div id="gameContent"></div>
        </div>
    </div>

    <div id="peSection" class="two-column-container">
        <div class="dates-column">
            <h2>Respuestas pregunta diaria</h2>
            <div id="peDates"></div>
        </div>
        <div class="content-column">
            <div id="peContent"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getFirestore, doc, collection, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwjJU19o3VmUNjr8ztNQax6Yl9nRPcdq4",
            authDomain: "tesis-test-f038e.firebaseapp.com",
            projectId: "tesis-test-f038e",
            storageBucket: "tesis-test-f038e.appspot.com",
            messagingSenderId: "474142825165",
            appId: "1:474142825165:web:d1a4c36023e9286aa3a784",
            measurementId: "G-82150V2QDK"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const email = localStorage.getItem("selectedEmail");
        const diarioDates = document.getElementById("diarioDates");
        const gameDates = document.getElementById("gameDates");
        const peDates = document.getElementById("peDates");
        const diarioContent = document.getElementById("diarioContent");
        const gameContent = document.getElementById("gameContent");
        const peContent = document.getElementById("peContent");

        if (!email) {
            diarioContent.innerHTML = "<p>No se proporcion√≥ ning√∫n correo.</p>";
            gameContent.innerHTML = "<p>No se proporcion√≥ ning√∫n correo.</p>";
            peContent.innerHTML = "<p>No se proporcion√≥ ning√∫n correo.</p>";
        } else {
            const userDocRef = doc(db, "users", email);

            // Funci√≥n para manejar botones activos
            function setActiveButton(activeBtn) {
                document.querySelectorAll('.date-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                activeBtn.classList.add('active');

                // Ocultar todos los contenidos
                diarioContent.innerHTML = '';
                gameContent.innerHTML = '';
                peContent.innerHTML = '';
            }

            // Mostrar contenido del diario
            const showDiarioContent = (data, btnElement) => {
                setActiveButton(btnElement);
                diarioContent.innerHTML = `
                    <div class="content-card">
                        <h3>${data.fecha}</h3>
                        <p><strong>Emoci√≥n:</strong> ${data.emocion}</p>
                        <p>${data.texto}</p>
                    </div>
                `;
            };

            // Mostrar contenido del juego (TB con opciones)
            const showGameContent = (date, responses, btnElement) => {
                setActiveButton(btnElement);

                const tbGroup = responses
                    .filter(resp => resp.questionId.startsWith("TB_"))
                    .sort((a, b) => {
                        const numA = parseInt(a.questionId.split("_")[1], 10);
                        const numB = parseInt(b.questionId.split("_")[1], 10);
                        return numA - numB;
                    });
                const formatTBQuestion = (resp) => {
                    const pregunta = preguntasTB[resp.questionId] || resp.questionId;
                    const opciones = opcionesTB[resp.questionId];

                    let html = `<div class="pregunta">
                        <p><strong>${pregunta}</strong></p>`;

                    if (opciones) {
                        html += `<ul>`;
                        opciones.forEach(op => {
                            const isSelected = op === resp.answer;
                            html += `
                            <li style="color:${isSelected ? 'green' : 'black'}; font-weight:${isSelected ? 'bold' : 'normal'}">
                                ${isSelected ? '‚úÖ ' : ''}${op}
                            </li>`;
                        });
                        html += `</ul>`;
                    } else {
                        html += `<p>${resp.answer}</p>`;
                    }

                    html += `</div>`;
                    return html;
                };

                let contentHTML = ``;

                tbGroup.forEach(resp => {
                    contentHTML += formatTBQuestion(resp);
                });

                contentHTML += `</div>`;
                gameContent.innerHTML = contentHTML;
            };

            // Mostrar contenido PE (directamente de Firebase)
            const showPeContent = (date, responses, btnElement) => {
                setActiveButton(btnElement);

                // Filtra solo los PE_ y arma el HTML
                let contentHTML = ``;

                responses
                    .filter(resp => resp.questionId.startsWith("PE_"))
                    .forEach(resp => {
                        const pregunta = preguntasPE[resp.questionId] || resp.questionId;
                        const opciones = opcionesPE[resp.questionId];

                        contentHTML += `<div class="pregunta">
        <p><strong>${pregunta}</strong></p>`;

                        if (opciones) {
                            contentHTML += `<ul>`;
                            opciones.forEach(op => {
                                const isSelected = op === resp.answer;
                                contentHTML += `
            <li style="
              color: ${isSelected ? 'green' : 'black'};
              font-weight: ${isSelected ? 'bold' : 'normal'}">
              ${isSelected ? '‚úÖ ' : ''}${op}
            </li>`;
                            });
                            contentHTML += `</ul>`;
                        } else {
                            // Si no definiste opciones en el mapa, solo muestro el texto
                            contentHTML += `<p>${resp.answer}</p>`;
                        }

                        contentHTML += `</div>`;  // cierre .pregunta
                    });

                contentHTML += `</div>`;  // cierre .content-card
                peContent.innerHTML = contentHTML;
            };

            // Cargar entradas del diario
            const loadDiario = async () => {
                const diarioSnapshot = await getDocs(collection(userDocRef, "diario"));
                diarioSnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const dateBtn = document.createElement("button");
                    dateBtn.className = "date-btn";
                    dateBtn.textContent = `üìì ${data.fecha}`;
                    dateBtn.onclick = () => showDiarioContent(data, dateBtn);
                    diarioDates.appendChild(dateBtn);
                });
            };

            // Cargar respuestas del juego
            const loadGameResponses = async () => {
                const gameSnapshot = await getDocs(collection(userDocRef, "gameResponses"));
                const grouped = {};

                gameSnapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const date = data.timestamp || "Sin fecha";
                    if (!grouped[date]) grouped[date] = [];
                    grouped[date].push(data);
                });

                for (const date in grouped) {
                    const dateBtn = document.createElement("button");
                    dateBtn.className = "date-btn";
                    dateBtn.textContent = `üìù ${date}`;
                    dateBtn.onclick = () => showGameContent(date, grouped[date], dateBtn);
                    gameDates.appendChild(dateBtn);
                }
            };

            // Cargar respuestas PE
            const loadPeResponses = async () => {
                // 1) Trae TODO de gameResponses
                const snapshot = await getDocs(collection(userDocRef, "gameResponses"));
                const grouped = {};

                // 2) Filtra solo los PE_ y agr√∫palos por fecha
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (!data.questionId?.startsWith("PE_")) return;      // <-- filtro PE_
                    const date = data.timestamp || "Sin fecha";
                    if (!grouped[date]) grouped[date] = [];
                    grouped[date].push(data);
                });

                // 3) Por cada fecha crea un bot√≥n en peDates
                for (const date in grouped) {
                    const btn = document.createElement("button");
                    btn.className = "date-btn";
                    btn.textContent = `üìÖ ${date}`;
                    btn.onclick = () => showPeContent(date, grouped[date], btn);
                    peDates.appendChild(btn);
                }

                // 4) Mensaje por defecto si no hay ning√∫n PE_
                if (peDates.children.length === 0) {
                    peDates.innerHTML = "<p>No hay respuestas PE para este usuario.</p>";
                }
            };

            // Definici√≥n de preguntas y opciones TB (se mantienen)
            const preguntasTB = {
                "TB_1": "1. ¬øC√≥mo ha sido el clima en tu coraz√≥n estos d√≠as?",
                "TB_2": "2. ¬øC√≥mo imaginas el camino hacia adelante?",
                "TB_3": "3. ¬øC√≥mo te hablas cuando las cosas no salen?",
                "TB_4": "4. ¬øQu√© tan cerca sientes las cosas que antes te alegraban?",
                "TB_5": "5. ¬øQu√© peso llevas en tu espalda hoy?",
                "TB_6": "6. ¬øSientes que mereces descansar de las batallas?",
                "TB_7": "7. ¬øQu√© ves cuando te miras?",
                "TB_8": "8. ¬øC√≥mo es la voz dentro de tu cabeza?",
                "TB_9": "9. ¬øC√≥mo est√° tu faro interno hoy?",
                "TB_10": "10. ¬øHan salido l√°grimas de tu nube interna?",
                "TB_11": "11. ¬øC√≥mo se siente tu cuerpo hoy?",
                "TB_12": "12. ¬øQu√© tan fuerte es tu im√°n para las cosas que te gustaban?",
                "TB_13": "13. ¬øC√≥mo te sientes al elegir un camino?",
                "TB_14": "14. ¬øQu√© lugar ocupas en tu propio universo?",
                "TB_15": "15. ¬øC√≥mo est√° tu bater√≠a interna hoy?",
                "TB_16": "16. ¬øC√≥mo va el ritmo de sue√±o en estos d√≠as?",
                "TB_17": "17. ¬øC√≥mo est√° tu term√≥metro de paciencia hoy?",
                "TB_18": "18. ¬øC√≥mo va tu hambre en esta traves√≠a?",
                "TB_19": "19. ¬øC√≥mo se siente tu foco hoy?",
                "TB_20": "20. ¬øQu√© tan pesado se siente tu cuerpo?",
                "TB_21": "21. √öltimamente, ¬øc√≥mo sientes tu inter√©s en la intimidad y el romance?",
            };

            const opcionesTB = {
                "TB_1": [
                    "Hay d√≠as soleados que me llenan de calma",
                    "A veces llueve, pero s√© que pasar√°",
                    "Las nubes grises no se van‚Ä¶",
                    "Siento una tormenta constante dentro de m√≠"
                ],
                "TB_2": [
                    "Veo senderos libres",
                    "Hay niebla, pero sigo caminando",
                    "Me cuesta ver algo m√°s all√° de hoy",
                    "Siento que el camino est√° bloqueado"
                ],
                "TB_3": [
                    "Me recuerdo que puedo intentarlo de nuevo",
                    "A veces me critico, pero trato de ser amable",
                    "Siento que todo lo que hago est√° mal",
                    "Creo que no sirvo para nada"
                ],
                "TB_4": [
                    "A√∫n las siento cerca, como un abrazo",
                    "Las veo, pero no las alcanzo del todo",
                    "Parecen estar detr√°s de un cristal",
                    "Es como si nunca hubieran existido"
                ],
                "TB_5": [
                    "Siento ligereza, como una pluma",
                    "Algunas piedras, pero puedo soltarlas",
                    "La mochila est√° llena‚Ä¶ me cuesta caminar",
                    "Es tan pesada que no me deja respirar"
                ],
                "TB_6": [
                    "S√≠, todos necesitamos paz",
                    "A veces, pero me cuesta creerlo ",
                    "No‚Ä¶ siento que debo seguir luchando",
                    "Creo que merezco sufrir"
                ],
                "TB_7": [
                    "A alguien que est√° aprendiendo",
                    "A veces me gusta, a veces no",
                    "A un extra√±o que no entiendo",
                    "A alguien que no quiero ser "
                ],
                "TB_8": [
                    "Es amiga, me anima a seguir",
                    "A veces es dura, pero trato de calmarla",
                    "Grita cosas que me duelen",
                    "Es un enemigo constante"
                ],
                "TB_9": [
                    "Brilla",
                    "Parpadea‚Ä¶ necesita cuidado ",
                    "Casi no tiene luz",
                    "Siento que se apag√≥"
                ],
                "TB_10": [
                    "S√≠, y me aliviaron",
                    "Algunas, pero las tragu√©",
                    "Llor√© hasta quedarme vac√≠o",
                    "Las l√°grimas no salen‚Ä¶ y duele"
                ],
                "TB_11": [
                    "Tranquilo, como un lago en calma",
                    "Algo inquieto, pero puedo manejarlo",
                    "Como un motor que no puede parar",
                    "Estoy colapsando por dentro"
                ],
                "TB_12": [
                    " A√∫n atrae, como antes ",
                    "Se debilit√≥, pero sigue ah√≠",
                    "Casi no siento su fuerza",
                    "Es como si nunca hubiera existido"
                ],
                "TB_13": [
                    "Seguro/a, conf√≠o en mis pasos",
                    "Dudo, pero sigo adelante",
                    "Me paralizo‚Ä¶ no s√© qu√© hacer",
                    "Siento que todas las opciones est√°n mal"
                ],
                "TB_14": [
                    "Soy una estrella √∫nica ",
                    "A veces brillo, a veces me escondo",
                    "Me siento como polvo olvidado en el espacio",
                    "Creo que ni siquiera existo en este mapa"
                ],
                "TB_15": [
                    "Cargada, lista para el d√≠a",
                    "Medio llena‚Ä¶ necesito recargar",
                    "En rojo‚Ä¶ apenas funciono",
                    "Apagada‚Ä¶ no puedo moverme"
                ],
                "TB_16": [
                    "Duermo igual que siempre, sin cambios",
                    "Estoy durmiendo un poco menos de lo normal.",
                    "Duermo much√≠simo menos, apenas logro descansar",
                    "Me despierto horas antes de lo habitual y ya no puedo volver a dormir."
                ],
                "TB_17": [
                    "En calma, como un jard√≠n zen",
                    "Algo caliente, pero lo manejo",
                    "caliente, un poco mas de lo habitual",
                    "Hirviendo‚Ä¶ exploto f√°cilmente"
                ],
                "TB_18": [
                    "Todo normal. Como igual que siempre",
                    "Tengo un poco menos de apetito de lo habitual.",
                    "Mi apetito ha bajado mucho, casi no tengo ganas de comer.",
                    "No tengo nada de apetito, podr√≠a pasar el d√≠a sin comer."
                ],
                "TB_19": [
                    "N√≠tido, como una lupa",
                    "Borroneado, pero sigo intentando",
                    "Roto en mil pedazos",
                    "Perdido en la niebla"
                ],
                "TB_20": [
                    "Ligero, como una pluma",
                    "Algo cargado, pero puedo moverme",
                    "Como si llevara piedras en los bolsillos",
                    "Siento que me hundo en el suelo"
                ],
                "TB_21": [
                    "Late con fuerza",
                    "Pulso irregular",
                    "Latido d√©bil",
                    "Completamente apagada"
                ]
            };

            const preguntasPE = {
                "PE_1": "1. ¬øLograste descansar un poco o la mente no te dej√≥?  ",
                "PE_2": "2. ¬øPudiste darle algo a tu cuerpo hoy?  ",
                "PE_3": "3. ¬øHubo algo que hicieras por ti, por peque√±o que fuera?  ",
                "PE_4": "4. ¬øHubo un momento en que sentiste un respiro?  ",
                "PE_5": "5. ¬øTuviste un momento donde  no te sentiste solo?  ",
                "PE_6": "6. ¬øLograste soltar una cosa que te abrumaba hoy?  ",
                "PE_7": "7. ¬øHubo algo, por minimo, que sintieras que hiciste?  ",
                "PE_8": "8. ¬øHubo un momento donde te sentiste mas seguro?  ",
            };

            const opcionesPE = {
                "PE_1": [
                    "Dormi lo necesario",
                    "Me cost√≥, pero cerr√© los ojos un rato‚Ä¶ ",
                    "Pas√© m√°s tiempo viendo el techo que durmiendo",
                    "La noche fue larga y fr√≠a‚Ä¶"
                ],
                "PE_2": [
                    "Com√≠ algo, aunque fuera peque√±o ",
                    "Un sorbo de agua‚Ä¶ y un pedacito de pan ",
                    " No pude‚Ä¶ pero lo intentar√© m√°s tarde",
                    "Hoy no pude‚Ä¶"
                ],
                "PE_3": [
                    "Me lav√© la cara‚Ä¶ o me cambi√© de ropa",
                    "Respir√© hondo una vez‚Ä¶ ",
                    "Solo sobreviv√≠‚Ä¶ ",
                    " No pude‚Ä¶"
                ],
                "PE_4": [
                    "Un segundo donde respire mas profundo",
                    "tal vez cuando me acoste en el piso",
                    "Solo aguante ...",
                    "Fue un dia pesado"
                ],
                "PE_5": [
                    "Alguien me mando un mensaje ... o tu estuviste aqui",
                    "Vi una serie y me senti acompa√±ado",
                    "Me senti solo ...",
                    "Me senti desconectado"
                ],
                "PE_6": [
                    "Deje una tarea para ma√±ana ... Y esta bien",
                    "Respire cuando senti  que colapsaba",
                    "Me culpe por no poder ...",
                    "La presion me gano ..."
                ],
                "PE_7": [
                    "Me levante ... o conteste un mensaje",
                    "Recogi un calcetin del suelo",
                    "Solo existi ...",
                    "No hoy ..."
                ],
                "PE_8": [
                    "Me escondi bajo las cobijas",
                    "Puse una cancion que me calma",
                    "Me senti fragil ...",
                    "El miedo me gano ..."
                ]
                // ‚Ä¶ y as√≠ sucesivamente
            };

            // Cargar todos los datos
            loadDiario();
            loadGameResponses();
            loadPeResponses();
        }

        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // 1) Cambia el bot√≥n activo
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // 2) Oculta todas las secciones y muestra la que toca
                const section = btn.dataset.section;
                ['diario', 'game', 'pe'].forEach(sec => {
                    document.getElementById(sec + 'Section').style.display = (sec === section ? 'flex' : 'none');
                });
            });
        });
    </script>
</body>

</html>